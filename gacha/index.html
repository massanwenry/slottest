<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¹ãƒ­ãƒƒãƒˆå‹ ãŠå°é£ã„ã‚¬ãƒãƒ£</title>
    <style>
        /* CSS */
        body {
            font-family: sans-serif;
            text-align: center;
            padding: 50px;
            background-color: #333; 
            color: white;
        }
        .container {
            background-color: #222;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            max-width: 600px;
            margin: 0 auto;
        }
        h1 {
            color: #ffcc00; 
            margin-bottom: 30px;
        }
        
        /* ã‚¹ãƒ­ãƒƒãƒˆã®ã‚³ãƒ³ãƒ†ãƒŠ */
        .slot-display {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            perspective: 500px;
        }
        
        /* å„æ¡ã®è¦‹ãŸç›® */
        .digit {
            width: 80px;
            height: 120px;
            margin: 0 10px;
            overflow: hidden;
            border: 5px solid #ffcc00;
            border-radius: 10px;
            background-color: #000;
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.5);
            font-size: 4em;
            color: #00ff00; 
            font-weight: bold;
            position: relative;
        }
        
        /* å›è»¢ã™ã‚‹æ•°å­—ã®ãƒªã‚¹ãƒˆ */
        .numbers {
            position: absolute;
            top: 0;
            width: 100%;
        }
        
        /* æ•°å­—ä¸€ã¤åˆ†ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        .numbers > div {
            height: 120px; 
            line-height: 120px;
            text-align: center;
        }

        .gacha-button {
            background-color: #ff5722; 
            color: white;
            padding: 15px 40px;
            font-size: 1.4em;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 30px;
            transition: background-color 0.3s, transform 0.1s;
        }
        .gacha-button:hover {
            background-color: #e64a19; 
            transform: scale(1.05);
        }
        .gacha-button:disabled {
            background-color: #777;
            cursor: not-allowed;
        }
        .result-text {
            margin-top: 20px;
            font-size: 1.2em;
            color: #ddd;
        }
        .yen {
            font-size: 0.5em;
            color: #ffcc00;
            font-weight: normal;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ° ã‚¹ãƒ­ãƒƒãƒˆã§ãŠå°é£ã„ã‚²ãƒƒãƒˆï¼ ğŸ°</h1>
        
        <p>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€ä»Šæ—¥ã®ãŠå°é£ã„ï¼ˆ10å††ï½100å††ï¼‰ã‚’æ±ºã‚ã‚ˆã†ï¼</p>
        
        <div class="slot-display">
            <div class="digit" id="digit3"><div class="numbers"></div></div>
            <div class="digit" id="digit2"><div class="numbers"></div></div>
            <div class="digit" id="digit1"><div class="numbers"></div></div>
            <div class="digit" style="border:none; background:none; box-shadow:none; width:50px; font-size:1.5em; line-height:120px; color:#ffcc00;">
                <span class="yen">å††</span>
            </div>
        </div>
        
        <button class="gacha-button" id="gachaButton">START!</button>
        
        <p class="result-text" id="message">çµæœå¾…ã¡...</p>
    </div>

    <script>
        // JavaScript
        const button = document.getElementById('gachaButton');
        const message = document.getElementById('message');
        
        const ALL_DIGITS_POOL = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
        // 1ã®ä½ã‚‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã•ã›ã‚‹ãŸã‚ 0-9 ã‚’ä½¿ç”¨ã€‚100ã®ä½ã¯ 0 ã¾ãŸã¯ 1ã€‚
        const digits = [
            // [0] 1ã®ä½ (å¸¸ã« 0 ã«ãªã‚‹)
            { element: document.querySelector('#digit1 .numbers'), finalValue: 0, pool: ALL_DIGITS_POOL, initialDigit: 0 }, 
            // [1] 10ã®ä½
            { element: document.querySelector('#digit2 .numbers'), finalValue: 0, pool: ALL_DIGITS_POOL, initialDigit: 1 }, 
            // [2] 100ã®ä½
            { element: document.querySelector('#digit3 .numbers'), finalValue: 0, pool: [0, 1], initialDigit: 0 } 
        ];
        const SPIN_DURATION = 3000; // 3000ms (3ç§’)
        const REPEAT_COUNT = 5; // æ•°å­—ã‚¹ãƒˆãƒªãƒƒãƒ—ã®ç¹°ã‚Šè¿”ã—å›æ•°
        const DIGIT_DELAY_MS = 300; // æ¡ã”ã¨ã®é…å»¶ (300ms)

        // æ•°å­—ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function createNumberStrip(pool) {
            let html = '';
            for (let j = 0; j < REPEAT_COUNT; j++) {
                for (const num of pool) {
                    html += `<div>${num}</div>`;
                }
            }
            return html;
        }

        // åˆæœŸåŒ–: å„ã‚¹ãƒ­ãƒƒãƒˆã«æ•°å­—ã®ã‚¹ãƒˆãƒªãƒƒãƒ—ã‚’ã‚»ãƒƒãƒˆã—ã€åˆæœŸä½ç½® (ä¾‹: "010") ã«ä½ç½®åˆã‚ã›
        digits.forEach(d => {
            d.element.innerHTML = createNumberStrip(d.pool);
            
            // 1ã¤ã®æ•°å­—ã®é«˜ã•ã‚’å–å¾—
            const digitHeight = d.element.querySelector('div').offsetHeight;
            
            // åˆæœŸè¡¨ç¤ºä½ç½®ã‚’åˆã‚ã›ã‚‹ (ä¾‹: 10ã®ä½ã¯ '1'ã€ä»–ã¯ '0')
            const initialIndexInPool = d.pool.indexOf(d.initialDigit);
            
            // ä¸­å¤®ã®ãƒ–ãƒ­ãƒƒã‚¯ã® 'initialDigit' ã«åˆã‚ã›ã‚‹
            const initialIndex = Math.floor(REPEAT_COUNT / 2) * d.pool.length + initialIndexInPool; 
            
            d.element.style.transform = `translateY(${-initialIndex * digitHeight}px)`;
            d.element.style.transition = 'none'; // åˆå›è¡¨ç¤ºæ™‚ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–
        });

        // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
        button.addEventListener('click', async () => {
            // å›è»¢ä¸­ã¯ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            button.disabled = true;
            message.textContent = "å›è»¢ä¸­...";

            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰çµæœã‚’å–å¾—
            const response = await fetch('/spin', { method: 'POST' });
            const data = await response.json();
            const resultAmount = data.amount; // ä¾‹: 80, 100

            // çµæœã®é‡‘é¡ã‚’å„æ¡ã«åˆ†è§£
            // 80 -> "080", 100 -> "100"
            const s = String(resultAmount).padStart(3, '0'); 
            
            // 1ã®ä½
            digits[0].finalValue = parseInt(s[2]); 
            // 10ã®ä½
            digits[1].finalValue = parseInt(s[1]); 
            // 100ã®ä½
            digits[2].finalValue = parseInt(s[0]); 

            // å›è»¢é–‹å§‹
            digits.forEach((d, index) => {
                const digitHeight = d.element.querySelector('div').offsetHeight; 

                // d.pool å†…ã§ã®æœ€çµ‚å€¤ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                const finalValueInPoolIndex = d.pool.indexOf(d.finalValue);

                // æœ€çµ‚ä½ç½®ã®è¨ˆç®—: æœ€å¾Œã®ç¹°ã‚Šè¿”ã—ãƒ–ãƒ­ãƒƒã‚¯ã«åˆã‚ã›ã‚‹
                const targetIndex = (d.pool.length * (REPEAT_COUNT - 1)) + finalValueInPoolIndex;
                
                // æœ€çµ‚çš„ãªYåº§æ¨™ (ä¸Šã«ç§»å‹•)
                const finalPosition = -targetIndex * digitHeight; 
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
                const transitionDelay = index * DIGIT_DELAY_MS; // æ¡ã”ã¨ã«é…å»¶
                const transitionDuration = SPIN_DURATION / 1000; // ç§’ã«å¤‰æ›
                
                // æ¸›é€Ÿã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
                d.element.style.transition = `transform ${transitionDuration}s cubic-bezier(0.25, 0.46, 0.45, 0.94) ${transitionDelay / 1000}s`;
                d.element.style.transform = `translateY(${finalPosition}px)`;
            });

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«å®Ÿè¡Œ
            // å…¨ã¦ã®æ¡ã®å›è»¢ãŒçµ‚äº†ã™ã‚‹æ™‚é–“ã‚’è¨ˆç®—: SPIN_DURATION + æœ€å¾Œã®æ¡ã®é…å»¶ + ä½™è£•
            const totalDuration = SPIN_DURATION + (digits.length - 1) * DIGIT_DELAY_MS;
            setTimeout(() => {
                message.textContent = `çµæœ: ${resultAmount}å†† ç²å¾—ï¼ ğŸ‰`;
                button.disabled = false;
            }, totalDuration + 500); 
        });

    </script>
</body>
</html>