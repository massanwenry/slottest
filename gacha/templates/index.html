HTML_TEMPLATE_SLOT = """
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>スロット型 お小遣いガチャ</title>
    <style>
        /* CSS */
        body {
            font-family: sans-serif;
            text-align: center;
            padding: 50px;
            background-color: #333; /* 背景を暗く */
            color: white;
        }
        .container {
            background-color: #222;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            max-width: 600px;
            margin: 0 auto;
        }
        h1 {
            color: #ffcc00; /* ゴールド系の色 */
            margin-bottom: 30px;
        }
        
        /* スロットのコンテナ */
        .slot-display {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            perspective: 500px; /* 3D回転のための遠近感 */
        }
        
        /* 各桁の見た目 */
        .digit {
            width: 80px;
            height: 120px;
            margin: 0 10px;
            overflow: hidden; /* 数字の回転を隠す */
            border: 5px solid #ffcc00;
            border-radius: 10px;
            background-color: #000;
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.5);
            line-height: 120px; /* 垂直方向の中央揃え */
            font-size: 4em;
            color: #00ff00; /* ネオングリーン */
            font-weight: bold;
            position: relative;
        }
        
        /* 回転する数字のリスト */
        .numbers {
            position: absolute;
            top: 0;
            width: 100%;
            transition: transform 0.1s; /* 滑らかな回転のためのトランジション */
        }
        
        .numbers.spinning {
            /* スロット回転アニメーション用のスタイルはJavaScriptで操作 */
        }

        .gacha-button {
            background-color: #ff5722; /* オレンジ */
            color: white;
            padding: 15px 40px;
            font-size: 1.4em;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 30px;
            transition: background-color 0.3s, transform 0.1s;
        }
        .gacha-button:hover {
            background-color: #e64a19; 
            transform: scale(1.05);
        }
        .gacha-button:disabled {
            background-color: #777;
            cursor: not-allowed;
        }
        .result-text {
            margin-top: 20px;
            font-size: 1.2em;
            color: #ddd;
        }
        .yen {
            font-size: 0.5em;
            color: #ffcc00;
            font-weight: normal;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎰 スロットでお小遣いゲット！ 🎰</h1>
        
        <p>ボタンを押して、今日のお小遣い（10円～100円）を決めよう！</p>
        
        <div class="slot-display">
            <div class="digit" id="digit3"><div class="numbers">0</div></div>
            <div class="digit" id="digit2"><div class="numbers">0</div></div>
            <div class="digit" id="digit1"><div class="numbers">0</div></div>
            <div class="digit" style="border:none; background:none; box-shadow:none; width:50px; font-size:1.5em; line-height:120px; color:#ffcc00;">
                <span class="yen">円</span>
            </div>
        </div>
        
        <button class="gacha-button" id="gachaButton">START!</button>
        
        <p class="result-text" id="message">結果待ち...</p>
    </div>

    <script>
        // JavaScript
        const button = document.getElementById('gachaButton');
        const message = document.getElementById('message');
        const digits = [
            { element: document.querySelector('#digit1 .numbers'), finalValue: 0, pool: [0] }, // 1の位は常に 0
            { element: document.querySelector('#digit2 .numbers'), finalValue: 0, pool: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9] }, // 10の位
            { element: document.querySelector('#digit3 .numbers'), finalValue: 0, pool: [0, 1] } // 100の位は 0 or 1
        ];
        const SPIN_DURATION = 3000; // 3秒間スロットを回転させる

        // 数字リストを生成するヘルパー関数
        function createNumberStrip(pool) {
            let html = '';
            // 回転中に多様な数字を見せるため、プールを複数回連結する
            for (let j = 0; j < 5; j++) {
                for (const num of pool) {
                    html += `<div>${num}</div>`;
                }
            }
            return html;
        }

        // 初期化: 各スロットに回転用の数字のストリップをセット
        digits.forEach(d => {
            d.element.innerHTML = createNumberStrip(d.pool);
            // 初期表示を中央の 0 に合わせる
            d.element.style.transform = 'translateY(0px)';
        });

        // ボタンクリック時の処理
        button.addEventListener('click', async () => {
            // 回転中はボタンを無効化
            button.disabled = true;
            message.textContent = "回転中...";

            // サーバーから結果を取得
            const response = await fetch('/spin', { method: 'POST' });
            const data = await response.json();
            const resultAmount = data.amount; // 例: 80

            // 結果の金額を各桁に分解
            // 80円 -> [8, 0, 0]
            // 100円 -> [0, 0, 1]
            const s = String(resultAmount).padStart(3, '0'); // "080" or "100"
            digits[0].finalValue = parseInt(s[2]); // 1の位 (常に0)
            digits[1].finalValue = parseInt(s[1]); // 10の位
            digits[2].finalValue = parseInt(s[0]); // 100の位

            // 回転開始
            digits.forEach((d, index) => {
                // スロットの高さ
                const digitHeight = d.element.offsetHeight / d.element.children.length; // 1つの数字の高さ

                // 最終的な位置を計算 (ストリップの最後のループから逆算して固定)
                // d.pool.length * 4 (数字のブロック数) + (d.pool.indexOf(d.finalValue) + 1)
                
                // 最終値の位置（ストリップの一番最後のブロックのインデックス）
                const finalValueIndex = d.pool.lastIndexOf(d.finalValue);
                // 最後のブロックに移動させるためのインデックス
                const targetIndex = (d.pool.length * 4) + finalValueIndex;
                
                // 最終的なY座標 (最後のブロックの最終値の位置)
                const finalPosition = -targetIndex * digitHeight; 
                
                // アニメーション設定
                d.element.style.transition = `transform ${SPIN_DURATION / 1000 + index * 0.5}s ease-out`; // 桁ごとに少し遅延
                d.element.style.transform = `translateY(${finalPosition}px)`;
            });

            // アニメーション終了後に実行
            setTimeout(() => {
                message.textContent = `結果: ${resultAmount}円 獲得！ 🎉`;
                button.disabled = false;
            }, SPIN_DURATION + 500); // 最後のスロットの回転時間 + 余裕

        });

    </script>
</body>
</html>